 >
<head>
<link href="css/main.css" type="text/css" rel="stylesheet">
<title>treeChat</title>
</head>
<body>
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
<script src="http://treechat-treechat.193b.starter-ca-central-1.openshiftapps.com/socket.io/socket.io.js"></script>
<div id="online_users">Online: {{online_users}}</div>
<div id="list_users">
  <div id="nickname"><textarea onKeyPress="return ( this.value.length < 50 );" style="width:100%; height:90% "  id="textarea_nickname"></textarea></div>
  <!--<div id="button_send_nick" class="button">Войти</div>-->
  <div id="list_user_window">
      <blog-post v-for="title in nick"
      v-bind:key="title.key"
      v-bind:title="title.title">
     </blog-post>
  </div>
</div>
<div id="chat_window">
  <div id="message_window"></div>
  <textarea id="input_msg" max-width="50" style="width:70% "id="message_input" cols="90" id="area"></textarea>
  </div>



<script>
var nickname;
var nicks;

window.online = 0;


function send(e) {
if(e.charCode == 13) {
  document.getElementById('input_msg').blur();
  var text = document.getElementById("input_msg").value;
    if(text!="") {
      var str = '<div class="msg_m">\
        <div class="msg_top_line"></div>\
        <span class="msg_text_m_style">'+ nickname + ': '+ text +'</span>\
        </div<\
        ';
 var div = document.createElement('div');
 div.innerHTML = str;
 message_window.appendChild(div);
 sendText();
 document.getElementById("input_msg").value = "";
 scroll_toEnd("message_window");
  }
 }
}
document.addEventListener('keypress', send);

var socket = io.connect('http://treechat-treechat.193b.starter-ca-central-1.openshiftapps.com');
socket.once('news', function (data, users_online, nick, nick_users){
  console.log(data);
  console.log('Users: ' + users_online);
  nickname = nick;
  for(var i = 0; i < nick_users.length; i++)
  {
    app_list_users.nick.push({title: nick_users[i]});
  }
  //app_list_users.nick = nicks;
  app_update_onlineUsers.online_users = users_online;
});

  //Уведомление о подключении других пользователей
socket.on('user connected', function(data)
 {
  app_update_onlineUsers.online_users++;
  app_list_users.nick.push({title: data});
 });

socket.on('user disconnect', function(data)
 {
  app_update_onlineUsers.online_users--;
  var index = app_list_users.nick.findIndex(obj => obj.title == data);
  app_list_users.nick.splice(index, 1);
 })
socket.on('new msg', function(data)
 {//Ожидаем сообщения от пользователей
  console.log('get: ' + data);
  var str = '<div class="msg_m">\
    <div class="msg_top_line"></div>\
    <span class="msg_text_m_style">' + data +'</span>\
    </div<\
    ';
    var div = document.createElement('div');
    div.innerHTML = str;
    message_window.appendChild(div);
    scroll_toEnd("message_window");
    sound_getMSG();

})

//document.addEventListener('visibilitychange', sound_getMSG, false);

function sendText(){
  var text = nickname + ": " + document.getElementById("input_msg").value;//Получаем текст из input
  socket.emit('my other event', text);//вызываем событие и отправляет текст
  console.log("send: " + text);
}

//Прокрутка окна с сообщениями вниз
function scroll_toEnd(id){
  var block = document.getElementById(id);
  block.scrollTop = block.scrollHeight;
}

//Воспроизведение звука, когда рприходит сообщение
function sound_getMSG()
 {
  //window.focus();
  var audio = new Audio();//Создаём новый элемент audio
  audio.src = 'sound/send_msg.mp3'; //путь к звуку
  audio.autoplay = true; //Автоматически запускается
  audio.preload = 'auto';
 }

//Устанавливает рандомное имя подключенному клиенту
 function getRandomName(min, max) {
    return "user" + Math.floor(Math.random() * (max - min + 1)) + min;
}
/////////////////////////////////////////////////////////////////

///////////////////////////VUE JS////////////////////////////////
//Онлайн
var app_update_onlineUsers = new Vue({
el: '#online_users',
data: {
  online_users: ''
}
})


Vue.component('blog-post', {
  props: ['title'],
  template: '<p class="lineListUsers">{{title}}</p>'
})
var app_list_users = new Vue({
  el: '#list_user_window',
  data: {
    nick: []
  }
})
////////////////////////////////////////////////////////////////////
</script>
</body>
</html>
