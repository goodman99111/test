 >
<head>
<link href="css/main.css" type="text/css" rel="stylesheet">
<title>treeChat</title>
</head>
<body>
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
<script src="http://localhost:8080/socket.io/socket.io.js"></script>
<div id="online_users">Online: {{online_users}}</div>
<div id="chat_window">
  <div id="message_window"></div>
  <textarea max-width="50" style="width:70% "id="message_input" cols="90" id="area"></textarea>
  <!--<button id="button_send" type="button" style="margin-left:70%" onclick="create()">Press</button>  -->
  <!--<div  id="button_send" style=" margin-left:70%" onclick="create()"><p id="textButton">Отправить</p></div>-->
  </div>
<script>
var users = sessionStorage.getItem('users');
window.online = 0;

function send(e)
{
//e = e ||  window.event;
if(e.charCode == 13) {
  document.getElementById('message_input').blur();
  var text = document.getElementById("message_input").value;
  //document.getElementById("message_input").selectionStart = 0;
    if(text!="") {
      var str = '<div class="msg_m">\
        <div class="msg_top_line"></div>\
        <span class="msg_text_m_style">'+ text +'</span>\
        </div<\
        ';
 var div = document.createElement('div');
 div.innerHTML = str;
 message_window.appendChild(div);
 sendText();
 document.getElementById("message_input").value = "";
 scroll_toEnd("message_window");
  }
 }
}
document.addEventListener('keypress', send);

var socket = io.connect('http://localhost:8080');
socket.once('news', function (data, users_online){
  console.log(data);
  console.log('Users: ' + users_online);
  //sessionStorage.setItem('users', users_online);
  app_update_onlineUsers.online_users = users_online;
});

  //Уведомление о подключении других пользователей
socket.on('user connected', function(data){
  console.log('New user connected. Users: ' + data);
  app_update_onlineUsers.online_users++;
});

socket.on('user disconnect', function(data){
  console.log('User disconnect. Users: ' + data);
  app_update_onlineUsers.online_users--;
})
socket.on('new msg', function(data)
 {//Ожидаем сообщения от пользователей
  console.log('get: ' + data);
  var str = '<div class="msg_m">\
    <div class="msg_top_line"></div>\
    <span class="msg_text_m_style">'+ data +'</span>\
    </div<\
    ';
    var div = document.createElement('div');
    div.innerHTML = str;
    message_window.appendChild(div);
    scroll_toEnd("message_window");
    sound_getMSG();
})

//document.addEventListener('visibilitychange', sound_getMSG, false);

function sendText(){
  var text = document.getElementById("message_input").value;//Получаем текст из input
  socket.emit('my other event', text);//вызываем событие и отправляет текст
  console.log("send: " + text);
}
function scroll_toEnd(id){
  var block = document.getElementById(id);
  block.scrollTop = block.scrollHeight;
}

function sound_getMSG()
{
  if(document.visibilityState == "hidden")//Если страница скрыта
  {
  var audio = new Audio();//Создаём новый элемент audio
  audio.src = 'sound/send_msg.mp3'; //путь
  audio.autoplay = true; //Автоматически запускается
  console.log("test: music");
  }
}

///////////////////////////VUE JS////////////////////////////////
var app_update_onlineUsers = new Vue({
el: '#online_users',
data: {
  online_users: ''
}
})
////////////////////////////////////////////////////////////////////
</script>
</body>
</html>
